<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DDoS Detection Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f5f7fa; }
        .card { border-radius: 12px; box-shadow: 0px 4px 10px rgba(0,0,0,0.1); }
        h2 { font-weight: 600; }
        .scrollable-box { max-height: 250px; overflow-y: auto; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container my-4">
        <h2 class="text-center mb-4">üåê Real-Time Anomaly Detection Dashboard</h2>

        <div class="row text-center mb-4">
            <div class="col-md-4"><div class="card p-3 bg-primary text-white"><h4>Total Requests Tracked</h4><h2 id="totalRequests">0</h2></div></div>
            <div class="col-md-4"><div class="card p-3 bg-success text-white"><h4>Unique IPs Seen</h4><h2 id="uniqueIps">0</h2></div></div>
            <div class="col-md-4"><div class="card p-3 bg-danger text-white"><h4>Anomalies Detected</h4><h2 id="alertCount">0</h2></div></div>
        </div>

        <div class="text-center mb-4">
            <button class="btn btn-lg btn-warning" onclick="generateTraffic()">‚ö° Generate Test Traffic</button>
        </div>

        <div class="row mb-4">
            <div class="col-md-6"><div class="card p-3"><h5 class="text-center">Requests per IP (Sliding Window)</h5><canvas id="ipChart"></canvas></div></div>
            <div class="col-md-6"><div class="card p-3"><h5 class="text-center">Total Traffic by Country</h5><canvas id="countryChart"></canvas></div></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>Live Traffic Log</h5>
                    <div class="table-responsive">
                        <table class="table table-striped"><thead class="table-dark" style="position: sticky; top: 0;"><tr><th>IP Address</th><th>Country</th><th>Recent Requests</th><th>Last Seen</th></tr></thead><tbody id="trafficTable"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h5>‚ö†Ô∏è Alerts Log</h5>
                    <div id="alertsBox" class="scrollable-box"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h5>üö´ Blocked IPs</h5>
                    <div id="blockedBox" class="scrollable-box">
                        <ul class="list-group" id="blockedIpList">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();

        let totalRequests = 0;
        const ipData = new Map();
        const countryData = {};

        // Chart configurations
        const ipChart = new Chart(document.getElementById("ipChart"), { type: "bar", data: { labels: [], datasets: [{ label: "Requests per IP", data: [], backgroundColor: "rgba(54, 162, 235, 0.7)" }] }, options: { indexAxis: 'y', responsive: true }});
        const countryChart = new Chart(document.getElementById("countryChart"), { type: "pie", data: { labels: [], datasets: [{ data: [], backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"] }] }, options: { responsive: true }});

        socket.on("traffic_update", function(data) {
            totalRequests++;
            document.getElementById("totalRequests").innerText = totalRequests;
            if (data.country && data.country !== 'Resolving...') { countryData[data.country] = (countryData[data.country] || 0) + 1; }
            ipData.set(data.ip, data);
            document.getElementById("uniqueIps").innerText = ipData.size;
            updateIpTable();
            updateCharts();
        });

        socket.on("ddos_alert", function(data) {
            const alertCountEl = document.getElementById("alertCount");
            alertCountEl.innerText = parseInt(alertCountEl.innerText) + 1;
            const alertsBox = document.getElementById("alertsBox");
            const alertDiv = document.createElement("div");
            alertDiv.className = "alert alert-danger p-2 mb-2";
            alertDiv.innerHTML = `<strong>ALERT:</strong> High traffic from <strong>${data.ip}</strong> (${data.country}) - <strong>${data.count}</strong> reqs.`;
            alertsBox.prepend(alertDiv);
        });

        // --- NEW JAVASCRIPT LOGIC FOR BLOCKED IPS ---

        // Function to create a list item for a blocked IP
        function addBlockedIpToList(ip) {
            const list = document.getElementById("blockedIpList");
            const listItem = document.createElement("li");
            listItem.className = "list-group-item d-flex justify-content-between align-items-center";
            listItem.id = `blocked-ip-${ip}`; // Assign a unique ID
            
            const ipSpan = document.createElement("span");
            ipSpan.textContent = ip;
            
            const unblockButton = document.createElement("button");
            unblockButton.className = "btn btn-outline-success btn-sm";
            unblockButton.textContent = "Unblock";
            unblockButton.onclick = function() {
                fetch(`/unblock/${ip}`).then(res => {
                    if (res.ok) console.log(`Unblock request sent for ${ip}`);
                });
            };
            
            listItem.appendChild(ipSpan);
            listItem.appendChild(unblockButton);
            list.appendChild(listItem);
        }

        // Fired when the dashboard first connects, to get the full list
        socket.on("update_blocked_list", function(data) {
            const list = document.getElementById("blockedIpList");
            list.innerHTML = ''; // Clear the list first
            data.blocked_ips.forEach(ip => addBlockedIpToList(ip));
        });

        // Fired when the server blocks a new IP
        socket.on("ip_blocked", function(data) {
            addBlockedIpToList(data.ip);
        });

        // Fired when the server unblocks an IP
        socket.on("ip_unblocked", function(data) {
            const listItem = document.getElementById(`blocked-ip-${data.ip}`);
            if (listItem) {
                listItem.remove();
            }
        });

        // --- END OF NEW JAVASCRIPT LOGIC ---

        function updateIpTable() { /* ... (rest of the functions are unchanged) ... */
            const tableBody = document.getElementById("trafficTable");
            tableBody.innerHTML = ''; 
            const sortedIps = [...ipData.values()].sort((a, b) => b.count - a.count);
            for (const item of sortedIps) { const row = document.createElement("tr"); row.innerHTML = `<td>${item.ip}</td><td>${item.country}</td><td>${item.count}</td><td>${item.last_seen}</td>`; tableBody.appendChild(row); }
        }
        function updateCharts() {
            const sortedIps = [...ipData.values()].sort((a, b) => b.count - a.count).slice(0, 10);
            ipChart.data.labels = sortedIps.map(d => d.ip); ipChart.data.datasets[0].data = sortedIps.map(d => d.count); ipChart.update();
            countryChart.data.labels = Object.keys(countryData); countryChart.data.datasets[0].data = Object.values(countryData); countryChart.update();
        }
        function generateTraffic() { fetch("/simulate_request", { method: "POST" }).then(res => res.json()).then(data => console.log("Test traffic sent from IP:", data.ip)).catch(err => console.error("Error:", err)); }
    </script>
</body>
</html>